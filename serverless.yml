service: laravel-demo

# オーソライザーが動作するruntime: nodejs10.x
# laravel(PHP)を動作するruntime: provided.al2
# 動作するruntimeが異なるのでここで指定しない(functionsの中で定義)
provider:
  name: aws
  # runtime: nodejs10.x
  region: ap-northeast-1
  stg: ${opt:stage, self:custom.defaultStage}

plugins:
  - ./vendor/bref/bref
  - serverless-plugin-ifelse

package:
  exclude:
    - node_modules/**
    - public/storage
    - storage/**
    - tests/**

# 変数定義：オーソライザー用に追加　
custom:
  defaultStage: dev
  # definitions:
  # authorizer:
  # ${file}はyaml or json
  # serverlessIfElse:
  #   - If: '"${file(./development.yml):app_dev}" == "local"'
  #     Set:
  #       authorizer:
  #         # Lambdaオーソライザーの設定
  #         # Lambda関数名（functionsのnameと一致させる必要あり）
  #         name: authorizer
  #         # キャッシュ時間
  #         resultTtlInSeconds: 0
  #         # Lambda関数に渡すヘッダー名
  #         identitySource: method.request.header.Authorization
  #         # Lambdaイベントペイロード
  #         type: request
  #     ElseSet:
  #       authorizer:
  #         # 何もしない。とりあえずartisan
  #         name: artisan
  definitions:
    authorizer:
      # Lambda関数名（basic認証しない時はauthorizer以外を指定し、同じ名前のファンクションを用意する）
      name: ${file(./development.yml):app_dev}
      # name: authorizer
      # キャッシュ時間
      resultTtlInSeconds: 0
      # Lambda関数に渡すヘッダー名
      identitySource: method.request.header.Authorization
      # Lambdaイベントペイロード
      type: request

functions:
  website:
    runtime: provided.al2
    handler: public/index.php
    # handler: handler.hello
    timeout: 28 # in seconds (API Gateway has a timeout of 29 seconds)
    layers:
      - ${bref:layer.php-73-fpm}
    events: # アクセス時に呼ばれるファンクション
      # - http: 'ANY /'
      # - http: 'ANY /{proxy+}'
      - http:
          path: '/'
          method: any
          # TODO:ここでオーソライザーが走ってしまうので、この制御が必要
          authorizer: ${self:custom.definitions.authorizer}

  authorizer:
    runtime: nodejs10.x
    handler: authorizer.handler

  non_authorizer:
    runtime: nodejs10.x
    handler: non_authorizer.handler

# [AWSリソースの設定]APIGateWayにオーソライザーを設定
# オーソライザが401を返したときに「WWW-Authenticate」ヘッダを返却させるための設定です
resources:
  Resources:
    GatewayResponse:
      Type: 'AWS::ApiGateway::GatewayResponse'
      Properties:
        ResponseParameters:
          gatewayresponse.header.WWW-Authenticate: "'Basic'"
        ResponseType: UNAUTHORIZED
        RestApiId:
          Ref: 'ApiGatewayRestApi'
        StatusCode: '401'